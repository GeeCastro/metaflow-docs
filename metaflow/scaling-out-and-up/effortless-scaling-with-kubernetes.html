<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EYFXNGNGB6"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-EYFXNGNGB6",{anonymize_ip:!0})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Metaflow Docs" href="/opensearch.xml"><title data-react-helmet="true">Effortless Scaling with Kubernetes | Metaflow Docs</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://docs.metaflow.org/img/Metaflow_Logo_Vertical_FullColor_Ribbon_Dark_RGB.png"><meta data-react-helmet="true" name="twitter:image" content="https://docs.metaflow.org/img/Metaflow_Logo_Vertical_FullColor_Ribbon_Dark_RGB.png"><meta data-react-helmet="true" property="og:url" content="https://docs.metaflow.org/metaflow/scaling-out-and-up/effortless-scaling-with-kubernetes"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Effortless Scaling with Kubernetes | Metaflow Docs"><meta data-react-helmet="true" name="description" content="Metaflow provides a set of easy-to-use tools that help you to make your code scale up (by running your code on a larger machine) or scale out (by allowing you to trivially parallelize your code over an arbitrarily large number of machines) using Kubernetes."><meta data-react-helmet="true" property="og:description" content="Metaflow provides a set of easy-to-use tools that help you to make your code scale up (by running your code on a larger machine) or scale out (by allowing you to trivially parallelize your code over an arbitrarily large number of machines) using Kubernetes."><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://docs.metaflow.org/metaflow/scaling-out-and-up/effortless-scaling-with-kubernetes"><link data-react-helmet="true" rel="alternate" href="https://docs.metaflow.org/metaflow/scaling-out-and-up/effortless-scaling-with-kubernetes" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://docs.metaflow.org/metaflow/scaling-out-and-up/effortless-scaling-with-kubernetes" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://5IZ8L9TJQL-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.4f08e196.css">
<link rel="preload" href="/assets/js/runtime~main.90a7a2ed.js" as="script">
<link rel="preload" href="/assets/js/main.e091d2d1.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/Metaflow_Logo_Horizontal_OneColor_White_RGB.svg" alt="Metaflow Logo" class="themedImage_W2Cr themedImage--light_TfLj" height="64px"><img src="/img/Metaflow_Logo_Horizontal_OneColor_White_RGB.svg" alt="Metaflow Logo" class="themedImage_W2Cr themedImage--dark_oUvU" height="64px"></div></a><a class="navbar__item navbar__link navbar__link--active" href="/">Python Docs</a><a class="navbar__item navbar__link" href="/v/r">R Docs</a><a href="https://outerbounds.com/docs/admin" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Admin Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div><div class="navbar__items navbar__items--right"><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Welcome to Metaflow for Python</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/introduction/why-metaflow">Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/getting-started/install">Getting Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/metaflow-on-aws">Metaflow on AWS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_VCh3" aria-current="page" href="/metaflow/basics">Developing with Metaflow</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/metaflow/basics">Basics of Metaflow</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/metaflow/client">Inspecting Flows and Results</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" tabindex="0" href="/metaflow/visualizing-results">Visualizing Results</a><button aria-label="Toggle the collapsible sidebar category &#x27;Visualizing Results&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/metaflow/debugging">Debugging with Metaflow</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active hasHref_VCh3" aria-current="page" tabindex="0" href="/metaflow/scaling-out-and-up">Scaling Out and Up</a><button aria-label="Toggle the collapsible sidebar category &#x27;Scaling Out and Up&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/metaflow/scaling-out-and-up/effortless-scaling-with-kubernetes">Effortless Scaling with Kubernetes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/metaflow/scaling-out-and-up/effortless-scaling-with-aws-batch">Effortless Scaling with AWS Batch</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/metaflow/data">Loading and Storing Data</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/metaflow/dependencies">Managing External Libraries</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/metaflow/failures">Dealing with Failures</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/metaflow/tagging">Organizing Results</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/going-to-production-with-metaflow/scheduling-metaflow-flows">Going to Production with Metaflow</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/internals-of-metaflow/technical-overview">Internals of Metaflow</a></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Effortless Scaling with Kubernetes</h1><p>Metaflow provides a set of easy-to-use tools that help you to make your code <em>scale up</em> (by running your code on a larger machine) or <em>scale out</em> (by allowing you to trivially parallelize your code over an arbitrarily large number of machines) using Kubernetes.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="requesting-resources-with-resources-decorator">Requesting resources with <code>resources</code> decorator<a class="hash-link" href="#requesting-resources-with-resources-decorator" title="Direct link to heading">â€‹</a></h2><p>Consider the following example:</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> metaflow </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> FlowSpec</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> step</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">BigSum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">FlowSpec</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:#393A34">@resources</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">memory</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">60000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cpu</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:#393A34">@step</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> numpy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        big_matrix </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> numpy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">random</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ranf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">80000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        t </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">sum</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> numpy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">big_matrix</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">took </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">end</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:#393A34">@step</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">end</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;The sum is %f.&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">sum</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Computing it took %dms.&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">took </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;__main__&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BigSum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This example creates a huge 80000x80000 random matrix, <code>big_matrix</code>. The matrix requires about 80000^2 <!-- -->*<!-- --> 8 bytes = 48GB of memory. </p><p>If you attempt to run this on your local machine, it is likely that the following will happen:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ python BigSum.py run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2019</span><span class="token plain">-11-29 02:43:39.689 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">/start/21975 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pid </span><span class="token number" style="color:#36acaa">83812</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> File </span><span class="token string" style="color:#e3116c">&quot;BugSum.py&quot;</span><span class="token plain">, line </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">, </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2018</span><span class="token plain">-11-29 02:43:39.689 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">/start/21975 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pid </span><span class="token number" style="color:#36acaa">83812</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> big_matrix </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> numpy.random.ranf</span><span class="token variable punctuation" style="color:#393A34">((</span><span class="token variable number" style="color:#36acaa">80000</span><span class="token variable punctuation" style="color:#393A34">,</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable number" style="color:#36acaa">80000</span><span class="token variable punctuation" style="color:#393A34">))</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2018</span><span class="token plain">-11-29 02:43:39.689 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">/start/21975 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pid </span><span class="token number" style="color:#36acaa">83812</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> File </span><span class="token string" style="color:#e3116c">&quot;mtrand.pyx&quot;</span><span class="token plain">, line </span><span class="token number" style="color:#36acaa">856</span><span class="token plain">, </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> mtrand.RandomState.random_sample</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2018</span><span class="token plain">-11-29 02:43:39.689 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">/start/21975 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pid </span><span class="token number" style="color:#36acaa">83812</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> File </span><span class="token string" style="color:#e3116c">&quot;mtrand.pyx&quot;</span><span class="token plain">, line </span><span class="token number" style="color:#36acaa">167</span><span class="token plain">, </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> mtrand.cont0_array</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2018</span><span class="token plain">-11-29 02:43:39.689 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">/start/21975 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pid </span><span class="token number" style="color:#36acaa">83812</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> MemoryError</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2018</span><span class="token plain">-11-29 02:43:39.689 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">/start/21975 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pid </span><span class="token number" style="color:#36acaa">83812</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2018</span><span class="token plain">-11-29 02:43:39.844 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">/start/21975 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pid </span><span class="token number" style="color:#36acaa">83812</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Task failed.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2018</span><span class="token plain">-11-29 02:43:39.844 Workflow failed.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Step failure:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Step start </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task-id </span><span class="token number" style="color:#36acaa">21975</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> failed.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This fails quickly due to a <code>MemoryError</code> on most laptops as we are unable to allocate 48GB of memory. </p><p>The <code>resources</code> decorator suggests resource requirements for a step. The <code>memory</code> argument specifies the amount of RAM in megabytes and <code>cpu</code> the number of CPU cores requested. It does not produce the resources magically, which is why the run above failed.</p><p>The <code>resources</code> decorator gains all its power in collaboration with Kubernetes. Note that for this section, you will need to have Metaflow working in an AWS cloud environment <!-- -->(<!-- -->either having <a href="/metaflow-on-aws/deploy-to-aws">deployed it yourself</a> or running in the <a href="/metaflow-on-aws/metaflow-sandbox">Metaflow sandbox</a>)</p><p>With the following command, you instruct Metaflow to run all your steps on Kubernetes:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ python BigSum.py run --with kubernetes</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The <code>--with kubernetes</code> option instructs Metaflow to run all tasks as separate Kubernetes pods, instead of using a local process for each task. It has the same effect as adding <code>@kubernetes</code> decorator to all steps in the code.</p><p>This time the run should succeed thanks to the large enough instance. Note that in this case the <code>resources</code> decorator is used as a prescription for the size of the box that Kubernetes should run the job on; please be sure that this resource requirement can be met.</p><p>You should see an output like this:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">The </span><span class="token function" style="color:#d73a49">sum</span><span class="token plain"> is </span><span class="token number" style="color:#36acaa">3200003911.795288</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Computing it took 4497ms.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In addition to <code>cpu</code> and <code>memory</code> you can specify <code>disk=D</code> to request D MB of disk space for the instance.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="using-kubernetes-selectively-with-kubernetes-decorator">Using Kubernetes selectively with <code>@kubernetes</code> decorator<a class="hash-link" href="#using-kubernetes-selectively-with-kubernetes-decorator" title="Direct link to heading">â€‹</a></h3><p>A close relative of the <code>resources</code> decorator is <code>kubernetes</code>. It takes exactly the same keyword arguments as <code>resources</code> but instead of being a mere suggestion, it forces the step to be run on Kubernetes.</p><p>The main benefit of <code>kubernetes</code> is that you can selectively run some steps locally and some on Kubernetes. In the example above, try replacing <code>resources</code> with <code>kubernetes</code> and run it as follows:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ python BigSum.py run</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You will see that the <code>start</code> step gets executed on a large Kubernetes pod but the <code>end</code> step, which does not need special resources, is executed locally without the additional latency of launching a Kubernetes pod. Executing a <a href="/metaflow/basics#foreach"><code>foreach</code></a> step launches parallel Kubernetes pods with the specified resources for the step.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="parallelization-over-multiple-cores">Parallelization over multiple cores<a class="hash-link" href="#parallelization-over-multiple-cores" title="Direct link to heading">â€‹</a></h3><p>When running locally, branches in your flow are executed in parallel as separate processes which the operating system can allocate to separate CPU cores. This means that your flow can utilize multiple cores without you having to do anything special besides defining branches in the flow.</p><p>When running <code>--with kubernetes</code>, branches are mapped to separate Kubernetes pods that are executed in parallel. All this makes sense for basic use cases. What if you want to utilize multiple cores on a Kubernetes pod?</p><p>Metaflow provides a utility function called <code>parallel_map</code> as an answer. This function is almost equivalent to <code>Pool().map</code> in the Python&#x27;s built-in <a href="https://docs.python.org/2/library/multiprocessing.html#multiprocessing.pool.multiprocessing.Pool.map" target="_blank" rel="noopener noreferrer">multiprocessing</a> library. The main differences are the following:</p><ul><li><code>parallel_map</code> supports lambdas and any other callables of Python.</li><li><code>parallel_map</code> does not suffer from bugs present in <code>multiprocessing</code>.</li><li><code>parallel_map</code> can handle larger amounts of data.</li></ul><p>Besides the Kubernetes use case, <code>parallel_map</code> may be appropriate for simple operations that might be too cumbersome to implement as separate steps.</p><p>Here is an extension of our previous example that implements a multi-core <code>sum()</code> by partitioning the matrix by row:</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> metaflow </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> FlowSpec</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> step</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> batch</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> parallel_map</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">BigSum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">FlowSpec</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:#393A34">@kubernetes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">memory</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">60000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cpu</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:#393A34">@step</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> numpy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        big_matrix </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> numpy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">random</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ranf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">80000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        t </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        parts </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> parallel_map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">lambda</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> big_matrix</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">i</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">10000</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">sum</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">parts</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">took </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">end</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:#393A34">@step</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">end</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;The sum is %f.&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">sum</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Computing it took %dms.&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">took </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;__main__&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BigSum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Note that we use <code>cpu=8</code> to request eight CPU cores from Kubernetes, so our <code>parallel_map</code> can benefit from optimal parallelism.</p><p>Disappointingly, in this case the parallel <code>sum</code> is not faster than the original simple implementation due to the overhead of launching separate processes in <code>parallel_map</code>. A less trivial operation might see a much larger performance boost.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="kubernetes-tips-and-tricks">Kubernetes tips and tricks<a class="hash-link" href="#kubernetes-tips-and-tricks" title="Direct link to heading">â€‹</a></h3><p>Here are some useful tips and tricks related to running Metaflow on Kubernetes.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="what-value-of-timeout-should-i-set"><strong>What value of <code>@timeout</code> should I set?</strong><a class="hash-link" href="#what-value-of-timeout-should-i-set" title="Direct link to heading">â€‹</a></h4><p>Metaflow sets a default timeout of 5 days so that you tasks don&#x27;t get stuck infinitely while running on Kubernetes. For more details on how to use <code>@timeout</code> please read <a href="/metaflow/failures#timing-out-with-timeout-decorator">this.</a></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="how-much-resources-can-i-request"><strong>How much <code>@resources</code> can I request?</strong><a class="hash-link" href="#how-much-resources-can-i-request" title="Direct link to heading">â€‹</a></h4><p>Here are the current defaults for different resource types:</p><ul><li><code>cpu</code>: 1</li><li><code>memory</code>: 4096 <!-- -->(<!-- -->4GB<!-- -->)</li><li><code>disk</code>: 10240 <!-- -->(<!-- -->10GB<!-- -->)</li></ul><p>When setting <code>@resources</code>, keep in mind the configuration of your Kubernetes cluster. Your pod will be stuck in a unschedulable state if Kubernetes is unable to provision the requested resources. Additionally, as a good measure, don&#x27;t request more resources than what your workflow actually needs. On the other hand, never optimize resources prematurely.</p><p>You can place your Kubernetes pod in a specific namespace by using the <code>namespace</code> argument. By default, all pods execute on a vanilla <a href="https://hub.docker.com/_/python/" target="_blank" rel="noopener noreferrer">python docker image</a> corresponding to the version of Python interpreter used to launch the flow and can be overridden using the <code>image</code> argument.</p><p>You can also specify the resource requirements on command line as well:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ python BigSum.py run --with kubernetes:cpu</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">4</span><span class="token plain">,memory</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10000</span><span class="token plain">,namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">foo,image</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ubuntu:latest</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="safeguard-flags"><strong>Safeguard flags</strong><a class="hash-link" href="#safeguard-flags" title="Direct link to heading">â€‹</a></h4><p>It is almost too easy to launch Kubernetes pods with Metaflow. Consider a foreach loop defined as follows:</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">params </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fanned_out</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> foreach</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;params&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>When run with <code>--with kubernetes</code>, this code would launch 1000 parallel pods which may turn out to be quite expensive.</p><p>To safeguard against inadvertent launching of many parallel pods, the <code>run</code> and <code>resume</code> commands have a flag <code>--max-num-splits</code> which fails the task if it attempts to launch more than 100 splits by default. Use the flag to increase the limit if you actually need more tasks.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ python myflow.py run --max-num-splits </span><span class="token number" style="color:#36acaa">200</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Another flag, <code>--max-workers</code>, limits the number of tasks run in parallel. Even if a foreach launched 100 splits, <code>--max-workers</code> would make only 16 <!-- -->(<!-- -->by default<!-- -->)<!-- --> of them run in parallel at any point in time. If you want more parallelism, increase the value of <code>--max-workers</code>.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ python myflow.py run --max-workers </span><span class="token number" style="color:#36acaa">32</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>If you interrupt a Metaflow run, any pods launched by the run get killed by Metaflow automatically. Even if something went wrong during the final cleanup, the tasks will finish and die eventually, at the latest when they hit the maximum time allowed for a pod.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="accessing-kubernetes-logs"><strong>Accessing Kubernetes logs</strong><a class="hash-link" href="#accessing-kubernetes-logs" title="Direct link to heading">â€‹</a></h4><p>As a convenience feature, you can also see the logs of any past step as follows:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ python bigsum.py logs </span><span class="token number" style="color:#36acaa">15</span><span class="token plain">/end</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="big-data">Big Data<a class="hash-link" href="#big-data" title="Direct link to heading">â€‹</a></h2><p>The previous sections focused on CPU and memory-bound steps. Loading and processing big data is often an IO-bound operation, which requires a different approach.</p><p>Read <a href="/metaflow/data">Loading and Storing Data</a> for more details about how to build efficient data pipelines in Metaflow.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="disk-space">Disk space<a class="hash-link" href="#disk-space" title="Direct link to heading">â€‹</a></h3><p>You can request higher disk space for pods by using the <code>disk</code> attribute of <code>@kubernetes</code>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="large-data-artifacts">Large data artifacts<a class="hash-link" href="#large-data-artifacts" title="Direct link to heading">â€‹</a></h3><p>Metaflow uses Python&#x27;s default object serialization format, <a href="https://docs.python.org/3/library/pickle.html" target="_blank" rel="noopener noreferrer">Pickle</a>, to persist data artifacts.</p><p>Unfortunately Python was not able to pickle objects larger than 2GB prior to Python 3.5. If you need to store large data artifacts, such as a large data frame, using a recent version of Python 3 is highly recommended.</p><p>In the rare cases where Metaflow&#x27;s built-in serialization does not work for you, you can use <a href="/metaflow/data#data-outside-tables-metaflow-s3">Metaflow S3 client</a> to persist arbitrary data in S3.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.dev/Netflix/metaflow-docs/blob/master/docs/metaflow/scaling-out-and-up/effortless-scaling-with-kubernetes.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/metaflow/scaling-out-and-up"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Scaling Out and Up</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/metaflow/scaling-out-and-up/effortless-scaling-with-aws-batch"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Effortless Scaling with AWS Batch</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#requesting-resources-with-resources-decorator" class="table-of-contents__link toc-highlight">Requesting resources with <code>resources</code> decorator</a><ul><li><a href="#using-kubernetes-selectively-with-kubernetes-decorator" class="table-of-contents__link toc-highlight">Using Kubernetes selectively with <code>@kubernetes</code> decorator</a></li><li><a href="#parallelization-over-multiple-cores" class="table-of-contents__link toc-highlight">Parallelization over multiple cores</a></li><li><a href="#kubernetes-tips-and-tricks" class="table-of-contents__link toc-highlight">Kubernetes tips and tricks</a></li></ul></li><li><a href="#big-data" class="table-of-contents__link toc-highlight">Big Data</a><ul><li><a href="#disk-space" class="table-of-contents__link toc-highlight">Disk space</a></li><li><a href="#large-data-artifacts" class="table-of-contents__link toc-highlight">Large data artifacts</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.90a7a2ed.js"></script>
<script src="/assets/js/main.e091d2d1.js"></script>
</body>
</html>